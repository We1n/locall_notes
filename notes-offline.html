<!--
  Single-file version of Local Notes Web App
  –ü—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ localStorage, —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω.
-->
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–∞–º–µ—Ç–∫–∏ –∏ –ø—Ä–æ–º–ø—Ç—ã (–æ–¥–∏–Ω —Ñ–∞–π–ª)</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
/* --- –í–°–¢–ê–í–ö–ê –ê–ö–¢–£–ê–õ–¨–ù–û–ì–û style.css --- */
/* –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
body {
  background-color: #f9fafb;
  color: #1f2937;
  font-family: 'Inter', 'Roboto', Arial, sans-serif;
  transition: background 0.3s, color 0.3s;
}
.bg-white, .bg-gray-50 {
  background-color: #fff !important;
  color: #1f2937 !important;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∏ */
.note-card {
  border-radius: 1.25rem; /* rounded-2xl */
  box-shadow: 0 4px 24px 0 rgba(31,41,55,0.06), 0 1.5px 3px 0 rgba(31,41,55,0.04);
  background: #fff;
  padding: 1.25rem;
  min-height: 170px;
  transition: box-shadow 0.2s, transform 0.15s;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.note-card:hover {
  box-shadow: 0 8px 32px 0 rgba(59,130,246,0.12), 0 3px 10px 0 rgba(31,41,55,0.07);
  transform: translateY(-2px) scale(1.01);
}

/* Sidebar */
.sidebar {
  background: #fff;
  border-radius: 1.25rem;
  box-shadow: 0 2px 8px 0 rgba(31,41,55,0.06);
  padding: 1.5rem 1rem;
  min-width: 220px;
  transition: background 0.3s;
  border: 1px solid #e5e7eb;
}
.sidebar-tag {
  display: inline-block;
  padding: 3px 12px;
  border-radius: 999px;
  font-size: 0.9em;
  margin: 2px 0;
  cursor: pointer;
  color: #2563eb;
  background: transparent;
  transition: background 0.18s, color 0.18s;
}
.sidebar-tag.selected {
  background: #3b82f6;
  color: #fff;
}
.sidebar-tag:hover {
  background: #e0e7ef;
  color: #1d4ed8;
}
body.dark .sidebar {
  background: #1e293b;
  color: #e5e7eb;
  border: 1px solid #334155;
}
body.dark .sidebar-tag {
  color: #60a5fa;
}
body.dark .sidebar-tag.selected {
  background: #60a5fa;
  color: #1e293b;
}
body.dark .sidebar-tag:hover {
  background: #334155;
  color: #60a5fa;
}

/* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
body.dark {
  background-color: #0f172a;
  color: #e5e7eb;
}
body.dark .bg-white,
body.dark .bg-gray-50 {
  background-color: #1e293b !important;
  color: #e5e7eb !important;
}
body.dark .note-card {
  background: #1e293b;
  color: #e5e7eb;
  box-shadow: 0 4px 24px 0 rgba(96,165,250,0.08), 0 1.5px 3px 0 rgba(16,185,129,0.05);
}
body.dark .note-card:hover {
  box-shadow: 0 8px 32px 0 rgba(96,165,250,0.18), 0 3px 10px 0 rgba(52,211,153,0.08);
}
body.dark .sidebar {
  background: #1e293b;
  color: #e5e7eb;
}

/* –ü–ª–∞–≤–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º */
body, .note-card, .sidebar, input, select, textarea, button {
  transition: background-color 0.3s, color 0.3s, box-shadow 0.2s, border-color 0.3s;
}

/* Chips */
.chip {
  display: inline-block;
  padding: 0.25em 0.8em;
  border-radius: 999px;
  font-size: 0.92em;
  font-weight: 500;
  margin-right: 0.25em;
  margin-bottom: 0.25em;
  background: #f3f4f6;
  color: #2563eb;
  transition: background 0.2s, color 0.2s;
}
.chip-blue {
  background: #2563eb;
  color: #fff;
}
.chip-green {
  background: #10b981;
  color: #fff;
}
body.dark .chip {
  background: #334155;
  color: #60a5fa;
}
body.dark .chip-blue {
  background: #60a5fa;
  color: #1e293b;
}
body.dark .chip-green {
  background: #34d399;
  color: #1e293b;
}

.note-card .edit-note-btn, .note-card .delete-note-btn {
  opacity: 0;
  pointer-events: none;
  background: none;
  border: none;
  padding: 0;
  margin: 0 2px;
  transition: opacity 0.18s, transform 0.18s;
}
.note-card.group:hover .edit-note-btn,
.note-card.group:hover .delete-note-btn,
.note-card:hover .edit-note-btn,
.note-card:hover .delete-note-btn {
  opacity: 1;
  pointer-events: auto;
}
.note-card .edit-note-btn svg,
.note-card .delete-note-btn svg {
  vertical-align: middle;
}
.note-card .edit-note-btn:hover, .note-card .delete-note-btn:hover {
  transform: scale(1.1);
}

#notes-list {
  display: grid;
  grid-template-columns: repeat(1, minmax(0, 1fr));
  gap: 1.5rem;
}
@media (min-width: 640px) {
  #notes-list {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}
@media (min-width: 1024px) {
  #notes-list {
    grid-template-columns: repeat(3, minmax(0, 1fr));
  }
}
@media (min-width: 1280px) {
  #notes-list {
    grid-template-columns: repeat(4, minmax(0, 1fr));
  }
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏ –º–µ–ª–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π */

#modal {
  transition: opacity 0.25s ease-out;
  background: rgba(0,0,0,0.45);
}

@keyframes modal-pop-in {
  from { transform: translateY(20px) scale(0.95); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}
.animate-modal {
  animation: modal-pop-in 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
}

@keyframes note-fade-in {
  from { opacity: 0; transform: translateY(15px) scale(0.98); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è Markdown –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
.markdown-content h1, .markdown-content h2, .markdown-content h3 { margin-top: 0.75em; margin-bottom: 0.25em; line-height: 1.2; font-weight: 600; }
.markdown-content h1 { font-size: 1.5em; }
.markdown-content h2 { font-size: 1.25em; }
.markdown-content h3 { font-size: 1.1em; }
.markdown-content p { margin-bottom: 0.5em; }
.markdown-content ul, .markdown-content ol { list-style-position: inside; padding-left: 1.5rem; margin-bottom: 0.5em; }
.markdown-content pre { background-color: #f3f4f6; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.5em 0; }
.markdown-content code:not(pre > code) { background-color: #f3f4f6; padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; }
.markdown-content blockquote { border-left: 4px solid #d1d5db; padding-left: 1rem; color: #6b7280; margin: 0.5em 0; }
.markdown-content a { color: #2563eb; text-decoration: underline; }
body.dark .markdown-content pre, body.dark .markdown-content code:not(pre > code) { background-color: #334155; }
body.dark .markdown-content blockquote { border-left-color: #4b5563; color: #9ca3af; }
body.dark .markdown-content a { color: #60a5fa; }

/* --- –ö–û–ù–ï–¶ style.css --- */
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="dir-picker-overlay" class="fixed inset-0 bg-gray-100 dark:bg-gray-900 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md">
      <h2 class="text-2xl font-bold mb-4 text-center text-gray-800 dark:text-gray-200">–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –¥–ª—è –∑–∞–º–µ—Ç–æ–∫</h2>
      <p class="text-center text-gray-600 dark:text-gray-400 mb-6">–í–∞—à–∏ –∑–∞–º–µ—Ç–∫–∏ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∞–º–∏ –ø–∞–ø–∫–µ.</p>
      <div id="recent-dirs-list" class="mb-4 space-y-2"></div>
      <button id="pick-new-dir-btn" class="mt-6 w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">–í—ã–±—Ä–∞—Ç—å –Ω–æ–≤—É—é –ø–∞–ø–∫—É</button>
    </div>
  </div>

  <div id="app-wrapper" class="hidden">
    <div class="container mx-auto py-6 px-2 sm:px-4">
    <div class="flex justify-end mb-2 gap-2">
      <button id="import-notes-btn" class="px-2 py-1 rounded bg-blue-200 hover:bg-blue-300 text-sm" title="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏">–ò–º–ø–æ—Ä—Ç</button>
      <input type="file" id="import-notes-input" accept=".json" style="display:none">
      <button id="export-notes-btn" class="px-2 py-1 rounded bg-gray-200 hover:bg-gray-300 text-sm" title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button id="toggle-theme" class="px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-xl" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
    </div>
    <h1 class="text-3xl font-bold mb-6 text-center">–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏ –∏ –ø—Ä–æ–º–ø—Ç—ã</h1>
    <div class="flex flex-col lg:flex-row gap-6">
      <!-- Sidebar —Å —Ç–µ–≥–∞–º–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ -->
      <aside class="sidebar w-full lg:w-auto lg:min-w-[220px]">
        <div id="sidebar-tags"></div>
      </aside>
      <!-- –û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å -->
      <main class="flex-1 bg-white rounded shadow p-4">
        <div class="flex flex-col sm:flex-row flex-wrap items-center mb-4 gap-2">
          <button id="add-note-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–º–µ—Ç–∫—É">–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</button>
          <button id="select-notes-dir-btn" class="px-3 py-1.5 text-sm bg-green-500 text-white rounded hover:bg-green-600 ml-2" title="–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –ø–∞–ø–∫—É –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫">–°–º–µ–Ω–∏—Ç—å –ø–∞–ø–∫—É</button>
          <input id="search" type="text" placeholder="–ü–æ–∏—Å–∫..." class="border rounded px-3 py-1 flex-1">
          <label for="sort-notes" class="ml-2">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
          <select id="sort-notes" class="border rounded px-2 py-1">
            <option value="date_desc">–î–∞—Ç–∞ (–Ω–æ–≤—ã–µ)</option>
            <option value="date_asc">–î–∞—Ç–∞ (—Å—Ç–∞—Ä—ã–µ)</option>
            <option value="title_asc">–ê–ª—Ñ–∞–≤–∏—Ç (A-–Ø)</option>
            <option value="title_desc">–ê–ª—Ñ–∞–≤–∏—Ç (–Ø-A)</option>
            <option value="tags_desc">–ë–æ–ª—å—à–µ —Ç–µ–≥–æ–≤</option>
            <option value="tags_asc">–ú–µ–Ω—å—à–µ —Ç–µ–≥–æ–≤</option>
            <option value="custom">–†—É—á–Ω–æ–π –ø–æ—Ä—è–¥–æ–∫ (drag-and-drop)</option>
          </select>
        </div>
        <div id="notes-list" class="grid gap-6"></div>
      </main>
    </div>
  </div>
</div>
  <div id="selected-dir-path" class="text-xs text-gray-500 mt-1 ml-auto mr-2">–ü–∞–ø–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞</div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏ -->
  <div id="modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-[#1e293b] p-7 rounded-2xl shadow-xl w-full max-w-lg relative flex flex-col gap-2 animate-modal" style="box-shadow: 0 8px 40px 0 rgba(31,41,55,0.18);">
      <button id="close-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-2xl" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
      <h2 class="text-xl font-bold mb-4 text-center" id="modal-title">–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</h2>
      <form id="note-form" class="flex flex-col gap-3">
  <input type="hidden" id="note-id">
  <input id="note-title" type="text" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" class="border rounded px-3 py-2 text-base" required>
  <input id="note-category" type="text" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" class="border rounded px-3 py-2 text-base">
  <input id="note-tags" type="text" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" class="border rounded px-3 py-2 text-base" list="tags-datalist">
  <datalist id="tags-datalist"></datalist>
  <textarea id="note-content" rows="4" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏ (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Markdown)..." class="border rounded px-3 py-2 text-base" required></textarea>
  <label class="block">
    <span>–ö–∞—Ä—Ç–∏–Ω–∫–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</span>
    <input id="note-image" type="file" accept="image/*" class="mt-1">
  </label>
  <label class="block mt-2">
    <span>–§–∞–π–ª—ã (PDF, TXT):</span>
    <input id="note-files" type="file" accept=".pdf,.txt" multiple class="mt-1">
  </label>
  <div class="flex gap-2 mt-5">
    <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button type="button" id="delete-note-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 hidden" title="–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É –Ω–∞–≤—Å–µ–≥–¥–∞">–£–¥–∞–ª–∏—Ç—å</button>
    <button type="button" id="cancel-modal" class="bg-gray-200 px-4 py-2 rounded-lg hover:bg-gray-300 transition" title="–û—Ç–º–µ–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å">–û—Ç–º–µ–Ω–∞</button>
  </div>
</form>
    </div>
  </div>
  <script>
    const LS_THEME = 'notes-theme-v2';
    const LS_KEY = 'notes-key';
    const LS_ORDER = 'notes-order';
    const IDB_KEY_RECENT_DIRS = 'notes-recent-dirs-v1';
    let notes = [];
    let notesDirectoryHandle = null;
    let customOrder = [];
    let selectedTags = [];
    let search = '';
    let sort = 'date_desc';
    let editingId = null;
    let isDark = false;

    const idb = {
      db: null,
      init() {
        return new Promise((resolve, reject) => {
          if (!window.indexedDB) {
            return reject("IndexedDB not supported");
          }
          const request = indexedDB.open('notes-fs-db', 1);
          request.onerror = e => reject("IndexedDB error: " + e.target.errorCode);
          request.onsuccess = e => {
            this.db = e.target.result;
            resolve();
          };
          request.onupgradeneeded = e => {
            if (!e.target.result.objectStoreNames.contains('keyval')) {
              e.target.result.createObjectStore('keyval');
            }
          };
        });
      },
      get(key) {
        return new Promise((resolve, reject) => {
          if (!this.db) return reject("DB not initialized");
          const tx = this.db.transaction('keyval', 'readonly');
          const store = tx.objectStore('keyval');
          const request = store.get(key);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      },
      set(key, value) {
        return new Promise((resolve, reject) => {
          if (!this.db) return reject("DB not initialized");
          const tx = this.db.transaction('keyval', 'readwrite');
          const store = tx.objectStore('keyval');
          const request = store.put(value, key);
          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      }
    };

    async function saveNoteToFile(note) {
      if (!notesDirectoryHandle) {
        console.error("Directory handle not initialized");
        return;
      }
      try {
        const fileHandle = await notesDirectoryHandle.getFileHandle(`${note.id}.json`, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(note, null, 2));
        await writable.close();
      } catch (e) {
        console.error("Error saving note:", e);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –ø–∞–ø–∫–∏.");
        throw e; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
      }
    }

    async function deleteNoteFile(noteId) {
      if (!notesDirectoryHandle) return;
      try {
        await notesDirectoryHandle.removeEntry(`${noteId}.json`);
      } catch (e) {
        console.error("Error deleting note file:", e);
      }
    }

    async function saveOrderToFile() {
      if (!notesDirectoryHandle) return;
      try {
        const fileHandle = await notesDirectoryHandle.getFileHandle('_order.json', { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(JSON.stringify(customOrder));
        await writable.close();
      } catch (e) {
        console.error("Error saving order:", e);
      }
    }

    function importNotes(importedNotes) {
      const promises = importedNotes.map(note => {
        const existing = notes.find(n => n.id === note.id);
        if (!existing) notes.push(note);
        return saveNoteToFile(note);
      });
      Promise.all(promises).then(loadData);
    }

    function saveNotes() {
      localStorage.setItem(LS_KEY, JSON.stringify(notes));
    }
    function loadNotes() {
      const raw = localStorage.getItem(LS_KEY);
      notes = raw ? JSON.parse(raw) : [];
    }
    function saveOrder() {
      localStorage.setItem(LS_ORDER, JSON.stringify(customOrder));
    }
    function loadOrder() {
      const raw = localStorage.getItem(LS_ORDER);
      customOrder = raw ? JSON.parse(raw) : [];
    }
    function saveTheme() {
      localStorage.setItem(LS_THEME, isDark ? 'dark' : 'light');
    }
    function loadTheme() {
      isDark = localStorage.getItem(LS_THEME) === 'dark' || (!('notes-theme-v2' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
      document.body.classList.toggle('dark', isDark);
      document.getElementById('toggle-theme').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    function getAllTags() {
      const tagSet = new Set();
      notes.forEach(n => (n.tags||[]).forEach(t => tagSet.add(t)));
      return Array.from(tagSet).sort();
    }

    function renderSidebar() {
      const tags = getAllTags();
      const sidebar = document.getElementById('sidebar-tags');
      sidebar.innerHTML = tags.map(tag =>
        `<span class="sidebar-tag${selectedTags.includes(tag)?' selected':''}" data-tag="${tag}">${tag}</span>`
      ).join('');
      sidebar.querySelectorAll('.sidebar-tag').forEach(el => {
        el.onclick = () => {
          if (selectedTags.includes(el.dataset.tag)) {
            selectedTags = selectedTags.filter(t => t!==el.dataset.tag);
          } else {
            selectedTags.push(el.dataset.tag);
          }
          renderSidebar();
          renderNotes();
        };
      });
    }

    function renderNotes() {
      let filtered = notes;
      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–µ–≥–∞–º
      if (selectedTags.length > 0) {
        filtered = filtered.filter(n => (n.tags||[]).some(tag => selectedTags.includes(tag)));
      }
      // –ü–æ–∏—Å–∫
      if (search) {
        const s = search.toLowerCase();
        filtered = filtered.filter(n => (n.title||'').toLowerCase().includes(s) || (n.content||'').toLowerCase().includes(s));
      }
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      let sorted = [...filtered];
      if (sort === 'custom') {
        let order = customOrder;
        if (!order.length) order = sorted.map(n=>n.id);
        sorted.sort((a,b) => order.indexOf(a.id) - order.indexOf(b.id));
      } else if (sort === 'date_desc') {
        sorted.sort((a,b) => (b.date||'').localeCompare(a.date||''));
      } else if (sort === 'date_asc') {
        sorted.sort((a,b) => (a.date||'').localeCompare(b.date||''));
      } else if (sort === 'title_asc') {
        sorted.sort((a,b) => (a.title||'').localeCompare(b.title||''));
      } else if (sort === 'title_desc') {
        sorted.sort((a,b) => (b.title||'').localeCompare(a.title||''));
      } else if (sort === 'tags_desc') {
        sorted.sort((a,b) => ((b.tags?.length)||0)-((a.tags?.length)||0));
      } else if (sort === 'tags_asc') {
        sorted.sort((a,b) => ((a.tags?.length)||0)-((b.tags?.length)||0));
      }
      // –†–µ–Ω–¥–µ—Ä
      const notesList = document.getElementById('notes-list');
      notesList.innerHTML = sorted.length ? sorted.map(note => {
        const drag = sort==='custom' ? 'draggable="true"' : '';
        return `<div class="border rounded p-3 bg-gray-50 shadow-sm note-card" style="opacity: 0" data-id="${note.id}" ${drag}>
          <div class="flex items-center justify-between mb-2">
            <div class="font-bold text-lg">${note.title||''}</div>
            <button class="text-blue-600 hover:underline text-sm edit-btn" data-id="${note.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="text-sm text-gray-500 mb-1">${note.category||''}</div>
          <div class="flex flex-wrap gap-1 mb-2">
            ${(note.tags||[]).map(tag => `<span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-800">${tag}</span>`).join('')}
          </div>
          <div class="mb-2 markdown-content">${window.marked ? window.marked.parse(note.content || '') : (note.content||'').replace(/\n/g,'<br>')}</div>
          ${note.image ? `<div class="mb-2"><img src="${note.image}" alt="img" class="max-h-40 rounded"></div>` : ''}
          ${note.attachments && note.attachments.length ? `
            <div class="mt-2">
              <div class="font-semibold text-xs mb-1">–í–ª–æ–∂–µ–Ω–∏—è:</div>
              <ul class="space-y-1">
                ${note.attachments.map(f => `
                  <li>
                    <a href="${f.data}" download="${f.name}" target="_blank" class="inline-flex items-center gap-1 text-blue-700 hover:underline">
                      ${f.type.includes('pdf') ? 'üìÑ' : f.type.includes('text') ? 'üìÑ' : 'üìé'}
                      ${f.name}
                    </a>
                  </li>
                `).join('')}
              </ul>
            </div>
          ` : ''}
        </div>`;
      }).join('') : '<div class="text-gray-400">–ù–µ—Ç –∑–∞–º–µ—Ç–æ–∫</div>';

      notesList.querySelectorAll('.note-card').forEach((card, index) => {
        card.style.animation = `note-fade-in 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) ${index * 0.04}s forwards`;
      });
      // Drag-and-drop
      if (sort==='custom') {
        let dragSrcId = null;
        notesList.querySelectorAll('.note-card').forEach(card => {
          card.ondragstart = e => { dragSrcId = card.dataset.id; card.classList.add('ring', 'ring-blue-300'); };
          card.ondragend = e => { dragSrcId = null; card.classList.remove('ring', 'ring-blue-300'); };
          card.ondragover = e => { e.preventDefault(); card.classList.add('ring', 'ring-blue-300'); };
          card.ondragleave = e => { card.classList.remove('ring', 'ring-blue-300'); };
          card.ondrop = e => {
            e.preventDefault();
            card.classList.remove('ring', 'ring-blue-300');
            const tgtId = card.dataset.id;
            if (dragSrcId && tgtId && dragSrcId!==tgtId) {
              let order = customOrder;
              if (!order.length) order = sorted.map(n=>n.id);
              const from = order.indexOf(dragSrcId);
              const to = order.indexOf(tgtId);
              if (from>-1 && to>-1) {
                order.splice(to, 0, order.splice(from, 1)[0]);
                customOrder = order;
                saveOrder();
                renderNotes();
              }
            }
          };
        });
      }
      // –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      notesList.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = () => openEditModal(btn.dataset.id);
      });
    }

    function renderTagsAndCategories() {
      // –°–æ–±—Ä–∞—Ç—å –≤—Å–µ —Ç–µ–≥–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –∑–∞–º–µ—Ç–æ–∫
      const tags = new Set();
      const cats = new Set();
      notes.forEach(note => {
        (note.tags||[]).forEach(t=>tags.add(t));
        if (note.category) cats.add(note.category);
      });
      window._allTags = Array.from(tags).sort();
      window._allCategories = Array.from(cats).sort();
    }

    function openModal() {
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modal-title');
      const noteForm = document.getElementById('note-form');
      const noteId = document.getElementById('note-id');
      const noteCategory = document.getElementById('note-category');
      const noteImage = document.getElementById('note-image');
      const noteFiles = document.getElementById('note-files');
      const delBtn = document.getElementById('delete-note-btn');

      if (!modal || !modalTitle || !noteForm || !noteId || !noteCategory || !noteImage || !noteFiles || !delBtn) {
        console.error("Required modal elements not found");
        return;
      }

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      modalTitle.textContent = '–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞';
      noteForm.reset();
      noteId.value = '';
      noteCategory.value = '';
      noteImage.value = '';
      noteFiles.value = '';
      delBtn.classList.add('hidden');
    }

    function openEditModal(noteId) {
      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modal-title');
      const noteForm = document.getElementById('note-form');
      const noteIdInput = document.getElementById('note-id');
      const noteTitle = document.getElementById('note-title');
      const noteCategory = document.getElementById('note-category');
      const noteTags = document.getElementById('note-tags');
      const noteContent = document.getElementById('note-content');
      const delBtn = document.getElementById('delete-note-btn');

      if (!modal || !modalTitle || !noteForm || !noteIdInput || !noteTitle || !noteCategory || !noteTags || !noteContent || !delBtn) {
        console.error("Required modal elements not found");
        return;
      }

      const note = notes.find(n => n.id === noteId);
      if (!note) {
        console.error("Note not found:", noteId);
        return;
      }

      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      modalTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É';
      noteIdInput.value = note.id;
      noteTitle.value = note.title;
      noteCategory.value = note.category || '';
      noteTags.value = note.tags ? note.tags.join(', ') : '';
      noteContent.value = note.content;
      delBtn.classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('modal').classList.add('hidden');
      document.body.style.overflow = '';
    }

    async function loadData() {
      if (!notesDirectoryHandle) return;
      notes = [];
      customOrder = [];
      try {
        const orderFileHandle = await notesDirectoryHandle.getFileHandle('_order.json').catch(() => null);
        if (orderFileHandle) {
          const file = await orderFileHandle.getFile();
          customOrder = JSON.parse(await file.text());
        }
        for await (const entry of notesDirectoryHandle.values()) {
          if (entry.kind === 'file' && entry.name.endsWith('.json') && entry.name !== '_order.json') {
            const file = await entry.getFile();
            const note = JSON.parse(await file.text());
            notes.push(note);
          }
        }
      } catch(e) {
        console.error("Error loading notes from directory", e);
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–æ–∫ –∏–∑ –ø–∞–ø–∫–∏.");
      }

      renderTagsAndCategories();
      renderSidebar();
      renderNotes();
    }

    async function pickNewDirectory() {
      try {
        const handle = await window.showDirectoryPicker();
        if (handle) {
          await selectDirectory(handle);
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:', err);
        if (err.name !== 'AbortError') {
          alert(`–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–∞–ø–∫–∏: ${err.message}`);
        }
      }
    }

    async function selectDirectory(handle) {
      if (!(await verifyPermission(handle, true))) {
        alert('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –ø–∞–ø–∫–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ.');
        return;
      }
      notesDirectoryHandle = handle;
      document.getElementById('dir-picker-overlay').style.display = 'none';
      document.getElementById('app-wrapper').classList.remove('hidden');
      document.getElementById('selected-dir-path').textContent = `–ü–∞–ø–∫–∞: ${handle.name}`;

      let recentDirs = (await idb.get(IDB_KEY_RECENT_DIRS)) || [];
      const existingIndex = recentDirs.findIndex(d => d.name === handle.name);
      if (existingIndex > -1) recentDirs.splice(existingIndex, 1);
      recentDirs.unshift({ name: handle.name, handle });
      if (recentDirs.length > 5) recentDirs.pop();
      await idb.set(IDB_KEY_RECENT_DIRS, recentDirs);

      initializeApp();
      await loadData();
    }

    function showDirPicker() {
      idb.get(IDB_KEY_RECENT_DIRS).then(recentDirs => {
        const listEl = document.getElementById('recent-dirs-list');
        if (recentDirs && recentDirs.length > 0) {
          listEl.innerHTML = '<h3 class="text-lg font-semibold mb-2 text-gray-700 dark:text-gray-300">–ù–µ–¥–∞–≤–Ω–∏–µ –ø–∞–ø–∫–∏:</h3>' +
          recentDirs.map(dir => `<button class="w-full text-left p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" data-name="${dir.name}">üìÅ ${dir.name}</button>`).join('');
          listEl.querySelectorAll('button').forEach(btn => {
            btn.onclick = async () => {
              const dir = recentDirs.find(d => d.name === btn.dataset.name);
              if (dir) await selectDirectory(dir.handle);
            };
          });
        } else {
          listEl.innerHTML = '';
        }
        document.getElementById('dir-picker-overlay').style.display = 'flex';
      });
    }

    function initializeApp() {
      if (window.appInitialized) return;
      window.appInitialized = true;

      const addNoteBtn = document.getElementById('add-note-btn');
      if (addNoteBtn) {
        addNoteBtn.onclick = openModal;
      }

      const searchInput = document.getElementById('search');
      if (searchInput) {
        searchInput.oninput = function() {
          search = this.value;
          renderNotes();
        };
      }

      const sortSelect = document.getElementById('sort-notes');
      if (sortSelect) {
        sortSelect.onchange = function() {
          sort = this.value;
          renderNotes();
        };
      }

      const themeToggle = document.getElementById('toggle-theme');
      if (themeToggle) {
        themeToggle.onclick = function() {
          isDark = !isDark;
          document.body.classList.toggle('dark', isDark);
          saveTheme();
          this.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        };
      }

      const importBtn = document.getElementById('import-notes-btn');
      const importInput = document.getElementById('import-notes-input');
      if (importBtn && importInput) {
        importBtn.onclick = () => importInput.click();
        importInput.onchange = function() {
          const file = this.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (ev) {
            try {
              const arr = JSON.parse(ev.target.result);
              if (Array.isArray(arr)) importNotes(arr);
            } catch (err) {
              console.error("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", err);
              alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞.");
            }
          };
          reader.readAsText(file);
          this.value = '';
        };
      }

      const exportBtn = document.getElementById('export-notes-btn');
      if (exportBtn) {
        exportBtn.onclick = function() {
          const dataStr = JSON.stringify(notes, null, 2);
          const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
          const exportFileDefaultName = 'notes.json';
          const linkElement = document.createElement('a');
          linkElement.setAttribute('href', dataUri);
          linkElement.setAttribute('download', exportFileDefaultName);
          linkElement.click();
        };
      }

      const saveBtn = document.getElementById('save-note-btn');
      if (saveBtn) {
        saveBtn.onclick = function() {
          document.getElementById('note-form').dispatchEvent(new Event('submit'));
        };
      }

      const cancelBtn = document.getElementById('cancel-modal');
      if (cancelBtn) {
        cancelBtn.onclick = closeModal;
      }

      const selectDirBtn = document.getElementById('select-notes-dir-btn');
      if (selectDirBtn) {
        selectDirBtn.onclick = showDirPicker;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      loadTheme();

      if (!window.showDirectoryPicker) {
        document.getElementById('dir-picker-overlay').innerHTML = `
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
          <h2 class="text-2xl font-bold mb-4 text-red-500">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</h2>
          <p class="text-gray-600 dark:text-gray-400">–î–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞–º–µ—Ç–∫–∞–º–∏ –≤ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π File System Access API, –Ω–∞–ø—Ä–∏–º–µ—Ä, Google Chrome, Microsoft Edge –∏–ª–∏ Opera.</p>
        </div>`;
        document.getElementById('dir-picker-overlay').style.display = 'flex';
        return;
      }

      await idb.init();
      document.getElementById('pick-new-dir-btn').onclick = pickNewDirectory;

      const recentDirs = (await idb.get(IDB_KEY_RECENT_DIRS)) || [];
      if (recentDirs.length > 0) {
        const lastUsed = recentDirs[0];
        if (await verifyPermission(lastUsed.handle, false)) {
          await selectDirectory(lastUsed.handle);
        } else {
          showDirPicker();
        }
      } else {
        showDirPicker();
      }
    });

    const noteForm = document.getElementById('note-form');
    if (noteForm) {
      noteForm.onsubmit = async function(e) {
        e.preventDefault();
        try {
          const id = document.getElementById('note-id').value;
          const title = document.getElementById('note-title').value;
          const category = document.getElementById('note-category').value;
          const tags = document.getElementById('note-tags').value.split(',').map(t => t.trim()).filter(t => t);
          const content = document.getElementById('note-content').value;
          const imageInput = document.getElementById('note-image');
          const attachmentsInput = document.getElementById('note-files');
          let image = null;
          let attachments = [];

          if (imageInput.files[0]) {
            image = await fileToBase64(imageInput.files[0]);
          }

          for (const f of attachmentsInput.files) {
            const data = await fileToBase64(f);
            attachments.push({name: f.name, type: f.type, data});
          }

          const existingNote = notes.find(n => n.id === id);
          let noteData;

          if (existingNote) {
            noteData = { ...existingNote, title, category, tags, content };
            if (image) noteData.image = image;
            if (attachments.length) noteData.attachments = attachments;
          } else {
            noteData = {
              id: id || crypto.randomUUID(),
              title,
              category,
              tags,
              content,
              image,
              attachments,
              date: new Date().toISOString()
            };
          }

          await saveNoteToFile(noteData);
          notes = notes.filter(n => n.id !== noteData.id);
          notes.push(noteData);

          renderTagsAndCategories();
          renderSidebar();
          renderNotes();
          closeModal();
        } catch (error) {
          console.error("Error saving note:", error);
          alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–º–µ—Ç–∫–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
        }
      };
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    async function verifyPermission(directoryHandle, readWrite) {
      const options = {};
      if (readWrite) {
        options.mode = 'readwrite';
      }
      if ((await directoryHandle.queryPermission(options)) === 'granted') {
        return true;
      }
      if ((await directoryHandle.requestPermission(options)) === 'granted') {
        return true;
      }
      return false;
    }
  </script>
</body>
</html>
